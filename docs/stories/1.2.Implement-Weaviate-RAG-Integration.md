# Story 1.2: Implement Weaviate RAG Integration

- **Status:** Done

## Story

- **As an** AI Agent,
- **I want** to retrieve relevant skills and job knowledge for the Target Role from a specialized knowledge base,
- **so that** the advice provided to users is accurate and based on semantic similarity.

## Acceptance Criteria

1. The backend can connect to Weaviate Cloud Service using proper authentication.
2. The backend can perform a vector search query using `near_text` based on the user's Target Role.
3. The query retrieves relevant documents from the `JobKnowledge` collection.
4. The retrieved documents are returned in a structured format for further processing.
5. Error handling is implemented for connection failures and empty results.

## Tasks / Subtasks

- [ ] **Task 1 (AC: 1):** Set up Weaviate client connection in the backend with proper authentication using environment variables.
  - [ ] Install `weaviate-client` Python package
  - [ ] Create Weaviate client configuration with API key and cluster URL
  - [ ] Add connection validation logic
- [ ] **Task 2 (AC: 2, 3):** Implement the RAG query function that performs semantic search using `near_text` on the Target Role.
  - [ ] Create function `query_job_knowledge(target_role: str)`
  - [ ] Implement vector search with `near_text` parameter
  - [ ] Configure query to return top 3-5 most relevant documents
- [ ] **Task 3 (AC: 4):** Parse and structure the Weaviate response into a usable format for the LLM.
  - [ ] Extract relevant fields (title, description, category) from results
  - [ ] Format results as a list of dictionaries
- [ ] **Task 4 (AC: 5):** Add error handling for Weaviate connection and query failures.
  - [ ] Handle authentication errors
  - [ ] Handle empty result sets
  - [ ] Handle network/timeout errors
  - [ ] Log errors appropriately

## Dev Notes

### Tech Stack

- **Backend Language:** Python 3.11+ [Source: architecture.md#tech-stack]
- **Backend Framework:** FastAPI [Source: architecture.md#tech-stack]
- **Vector Database:** Weaviate Cloud Service [Source: architecture.md#tech-stack]
- **Deployment:** Vercel Serverless Functions [Source: architecture.md#platform-and-infrastructure-choice]

### Weaviate Configuration

- **Collection Name:** `JobKnowledge` [Source: architecture.md#database-schema]
- **Schema Properties:**
  - `title`: text - Job role or skill title
  - `description`: text - Detailed description of the role/skill
  - `category`: text - Category classification
- **Vectorizer:** `text2vec-transformers` [Source: architecture.md#database-schema]
- **Query Method:** Use `near_text` for semantic similarity search based on Target Role input [Source: prd.md#technical-specifications]

### API Integration

- **Environment Variables Required:**
  - `WEAVIATE_URL`: Weaviate cluster URL
  - `WEAVIATE_API_KEY`: Authentication key for Weaviate Cloud
- **Query Parameters:**
  - Use `limit` parameter to retrieve top 3-5 documents
  - Include `certainty` threshold (e.g., 0.7) to ensure quality results

### File Locations

- **Backend Code:** `api/index.py` or create `api/weaviate_client.py` for separation of concerns [Source: architecture.md#unified-project-structure]
- **Environment Config:** `.env` file (not committed), `.env.example` for reference [Source: architecture.md#unified-project-structure]
- **Dependencies:** Add to `api/requirements.txt` [Source: architecture.md#unified-project-structure]

### Data Flow

This is Step 3-4 in the core workflow:

1. Backend receives user input (Current Role, Target Role)
2. **→ Backend queries Weaviate with Target Role (THIS STORY)**
3. **→ Weaviate returns relevant skill documents (THIS STORY)**
4. Backend passes documents to FriendliAI for analysis (Next Story)
   [Source: architecture.md#core-workflows]

### Previous Story Insights

From Story 1.1 (Frontend UI):

- The frontend sends `UserInput` model with `currentRole` and `targetRole` fields
- API endpoint is `POST /api/generate-career-path`
- Frontend expects a `CareerPath` response model
  [Source: docs/stories/1.1.Implement-Frontend-UI.md]

### Testing Requirements

- **Testing Strategy:** Manual testing for MVP, no automated tests required [Source: architecture.md#testing-strategy]
- **Manual Test Cases:**
  - Test successful connection to Weaviate
  - Test query with valid Target Role (e.g., "Machine Learning Engineer")
  - Test query with invalid/unknown Target Role
  - Test error handling for connection failures
  - Verify retrieved documents contain relevant skills

### Error Handling

- Implement try-catch blocks for all Weaviate operations
- Return meaningful error messages to the orchestrator
- Log all errors for debugging purposes
- Consider fallback behavior if Weaviate is unavailable (for demo resilience)

## Change Log

| Date       | Version | Description   | Author             |
| :--------- | :------ | :------------ | :----------------- |
| 2025-10-01 | 1.0     | Initial draft | Bob (Scrum Master) |
