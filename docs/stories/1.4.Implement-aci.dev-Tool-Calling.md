# Story 1.4: Implement aci.dev Tool Calling for Course Recommendations

- **Status:** Done

## Story

- **As an** AI Agent,
- **I want** to call an external tool to search for learning content for each recommended skill,
- **so that** I can provide actionable course links to users.

## Acceptance Criteria

1. The backend can connect to aci.dev Agent Gateway using proper authentication.
2. The backend can define and register a tool function `search_learning_content(skill: str)` with aci.dev.
3. FriendliAI can call the registered tool through aci.dev for each of the 3 recommended skills.
4. The tool returns a structured list of course recommendations (title, URL, platform) for each skill.
5. The course recommendations are integrated into the final career path response.
6. Error handling is implemented for tool calling failures.

## Tasks / Subtasks

- [x] **Task 1 (AC: 1):** Set up aci.dev client connection with proper authentication.
  - [x] Install required packages for aci.dev integration
  - [x] Configure API key from environment variables
  - [x] Add connection validation logic
- [x] **Task 2 (AC: 2):** Implement the `search_learning_content` tool function.
  - [x] Create function `search_learning_content(skill: str)` that returns mock course data
  - [x] Define tool schema for aci.dev registration
  - [x] Register tool with aci.dev gateway
- [x] **Task 3 (AC: 3):** Update FriendliAI integration to support tool calling.
  - [x] Modify FriendliAI client to enable function calling capability
  - [x] Configure FriendliAI to use registered tools from aci.dev
  - [x] Implement tool execution flow
- [x] **Task 4 (AC: 4, 5):** Parse and integrate tool results into the career path response.
  - [x] Extract course recommendations from tool responses
  - [x] Format course data (title, URL, platform) for each skill
  - [x] Integrate into the final `CareerPath` response model
- [x] **Task 5 (AC: 6):** Add error handling for tool calling failures.
  - [x] Handle authentication errors
  - [x] Handle tool execution failures
  - [x] Handle timeout errors
  - [x] Provide fallback behavior if tool calling fails
  - [x] Log errors appropriately

## Dev Notes

### Tech Stack

- **Backend Language:** Python 3.11+ [Source: architecture.md#tech-stack]
- **Backend Framework:** FastAPI [Source: architecture.md#tech-stack]
- **Agent Gateway:** aci.dev [Source: architecture.md#tech-stack]
- **LLM Provider:** FriendliAI (with tool calling capability) [Source: prd.md#technical-specifications]

### aci.dev Configuration

- **Tool Name:** `search_learning_content`
- **Tool Purpose:** Search for learning resources (courses, tutorials) for a given skill
- **Mock Data:** For MVP, return hard-coded course recommendations for expected skills
- **Environment Variables Required:**
  - `ACI_API_KEY`: Authentication key for aci.dev
  - `ACI_BASE_URL`: Base URL for aci.dev API (if needed)

### Tool Function Specification

The `search_learning_content` tool should:

1. **Input:** `skill` (string) - The skill to search courses for
2. **Output:** JSON array of course objects with:
   - `title`: Course title
   - `url`: Direct link to the course
   - `platform`: Platform name (e.g., "YouTube", "Udemy", "Coursera")
   - `duration`: Estimated duration (optional)
   - `level`: Difficulty level (e.g., "Beginner", "Intermediate")

Example mock data structure:

```json
[
  {
    "title": "Python for Machine Learning - Complete Course",
    "url": "https://www.youtube.com/watch?v=example1",
    "platform": "YouTube",
    "duration": "4 hours",
    "level": "Beginner"
  },
  {
    "title": "Machine Learning A-Z™: Hands-On Python",
    "url": "https://www.udemy.com/course/example",
    "platform": "Udemy",
    "duration": "44 hours",
    "level": "Intermediate"
  }
]
```

### Mock Course Data

For MVP, provide hard-coded responses for common skills:

- **Python:** Python tutorials and courses
- **Machine Learning:** ML courses and resources
- **TensorFlow/PyTorch:** Deep learning framework tutorials
- **Data Science:** Data science bootcamps
- **React/Vue/Angular:** Frontend framework courses
- **Node.js:** Backend JavaScript courses
- **Docker/Kubernetes:** DevOps and containerization
- **AWS/Azure/GCP:** Cloud platform certifications
- **Default:** Generic programming courses for unknown skills

### FriendliAI Tool Calling Integration

- **Model Requirement:** Use a model that supports function calling (e.g., Llama 3.1 8B Instruct) [Source: prd.md#technical-specifications]
- **Tool Calling Flow:**
  1. FriendliAI receives the 3 skills from skill gap analysis
  2. For each skill, FriendliAI decides to call `search_learning_content`
  3. aci.dev executes the tool and returns course recommendations
  4. FriendliAI incorporates the results into the final response

### File Locations

- **Backend Code:** Create `api/aci_client.py` for aci.dev integration [Source: architecture.md#unified-project-structure]
- **Tool Functions:** Create `api/tools.py` for tool function definitions
- **Main Orchestrator:** Update `api/index.py` to orchestrate tool calling [Source: architecture.md#unified-project-structure]
- **Environment Config:** Add to `.env` file (not committed), update `.env.example` [Source: architecture.md#unified-project-structure]
- **Dependencies:** Add to `api/requirements.txt` [Source: architecture.md#unified-project-structure]

### Data Flow

This is Step 9-11 in the core workflow:

1. Backend receives user input (Current Role, Target Role)
2. Backend queries Weaviate with Target Role (Story 1.2 - COMPLETED)
3. Weaviate returns relevant skill documents (Story 1.2 - COMPLETED)
4. Backend passes documents to FriendliAI for analysis (Story 1.3 - COMPLETED)
5. FriendliAI analyzes and returns top 3 skills (Story 1.3 - COMPLETED)
6. **→ FriendliAI calls aci.dev tool for each skill (THIS STORY)**
7. **→ aci.dev executes `search_learning_content` and returns courses (THIS STORY)**
8. **→ Backend integrates course recommendations into response (THIS STORY)**
9. Backend will generate code snippet (Next Story)
   [Source: architecture.md#core-workflows]

### Previous Story Insights

From Story 1.3 (FriendliAI LLM Integration):

- FriendliAI returns a list of 3 skill names as strings
- The `analyze_skill_gap()` function is in `api/friendli_client.py`
- FriendliAI uses Llama 3.1 8B Instruct model which supports function calling
  [Source: docs/stories/1.3.Implement-FriendliAI-LLM-Integration.md]

### Integration Points

- **Input:** Receives list of 3 skills from FriendliAI skill gap analysis
- **Output:** Returns enhanced career path with course recommendations for each skill
- **Next Step:** Code snippet generation (Story 1.5) and Daytona validation (Story 1.6)

### Response Model Update

Update the `CareerPath` response model to include course recommendations:

```python
class Course(BaseModel):
    title: str
    url: str
    platform: str
    duration: Optional[str] = None
    level: Optional[str] = None

class Skill(BaseModel):
    name: str
    courses: List[Course]

class CareerPath(BaseModel):
    current_role: str
    target_role: str
    skills: List[Skill]  # Updated to include courses
    # ... other fields
```

### Testing Requirements

- **Testing Strategy:** Manual testing for MVP, no automated tests required [Source: architecture.md#testing-strategy]
- **Manual Test Cases:**
  - Test successful connection to aci.dev
  - Test tool registration with aci.dev
  - Test FriendliAI calling the tool for each skill
  - Test with common skills (Python, Machine Learning, React)
  - Test with unknown skills (should return default courses)
  - Test error handling for tool calling failures
  - Verify course recommendations are properly formatted
  - Verify all 3 skills receive course recommendations

### Error Handling

- Implement try-catch blocks for all aci.dev operations
- Return meaningful error messages to the orchestrator
- Log all errors for debugging purposes
- Provide fallback behavior if tool calling fails (e.g., return generic course links)
- Ensure the system can continue even if some tool calls fail

### Performance Considerations

- Set appropriate timeout values for tool execution (e.g., 10 seconds per tool call)
- Consider parallel execution of tool calls for the 3 skills if possible
- Cache tool responses for common skills (optional for MVP)

## Change Log

| Date       | Version | Description                                  | Author               |
| :--------- | :------ | :------------------------------------------- | :------------------- |
| 2025-10-02 | 1.0     | Initial draft                                | Full Stack Developer |
| 2025-10-02 | 2.0     | Implementation completed - All tests passing | Full Stack Developer |
